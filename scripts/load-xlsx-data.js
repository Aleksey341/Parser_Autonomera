/**
 * ============================================================================
 * ETL —Å–∫—Ä–∏–ø—Ç: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel —Ñ–∞–π–ª–∞
 * –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∞–π–ª–æ–º "–û—Ü–µ–Ω–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è v_1.xlsx"
 * ============================================================================
 */

const XLSX = require('xlsx');
const path = require('path');
const fs = require('fs');
const pool = require('../db/postgres');

/**
 * –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π –ú–û –Ω–∞ ID
 */
const MO_MAPPING = {
  '–ì–æ—Ä–æ–¥ –õ–∏–ø–µ—Ü–∫': 1,
  '–≥. –õ–∏–ø–µ—Ü–∫': 1,
  '–õ–∏–ø–µ—Ü–∫': 1,
  '–õ–∏–ø–µ—Ü–∫–∏–π —Ä–∞–π–æ–Ω': 2,
  '–õ–∏–ø–µ—Ü–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 2,
  '–ï–ª–µ—Ü': 4,
  '–ì–æ—Ä–æ–¥ –ï–ª–µ—Ü': 4,
  '–≥. –ï–ª–µ—Ü': 4,
  '–ï–ª–µ—Ü–∫–∏–π —Ä–∞–π–æ–Ω': 3,
  '–ï–ª–µ—Ü–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 3,
  '–õ–µ–±–µ–¥—è–Ω—å': 6,
  '–ì–æ—Ä–æ–¥ –õ–µ–±–µ–¥—è–Ω—å': 6,
  '–≥. –õ–µ–±–µ–¥—è–Ω—å': 6,
  '–õ–µ–±–µ–¥—è–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω': 5,
  '–õ–µ–±–µ–¥—è–Ω—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 5,
  '–°—Ç–∞–Ω–æ–≤–ª—è–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω': 7,
  '–°—Ç–∞–Ω–æ–≤–ª—è–Ω—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 7,
  '–î–æ–±—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω': 8,
  '–î–æ–±—Ä–æ–≤—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 8,
  '–¢–∞–º–±–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω': 9,
  '–¢–∞–º–±–æ–≤—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 9,
  '–ì—Ä—è–∑–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω': 10,
  '–ì—Ä—è–∑–∏–Ω—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 10
};

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
 */
async function loadExcelData(excelPath) {
  console.log('\n' + '='.repeat(70));
  console.log('üì• –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó EXCEL');
  console.log('='.repeat(70));

  if (!fs.existsSync(excelPath)) {
    console.error(`‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${excelPath}`);
    return;
  }

  try {
    // –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
    const workbook = XLSX.readFile(excelPath);
    console.log(`‚úÖ –§–∞–π–ª –æ—Ç–∫—Ä—ã—Ç`);
    console.log(`üìä –õ–∏—Å—Ç—ã –≤ —Ñ–∞–π–ª–µ: ${workbook.SheetNames.join(', ')}`);

    const client = await pool.connect();

    try {
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ª–∏—Å—Ç (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ, –µ—Å–ª–∏ —ç—Ç–æ —Å–ª—É–∂–µ–±–Ω—ã–π)
      for (const sheetName of workbook.SheetNames) {
        console.log(`\nüîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ª–∏—Å—Ç: "${sheetName}"`);

        const worksheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(worksheet);

        console.log(`   –°—Ç—Ä–æ–∫ –≤ –ª–∏—Å—Ç–µ: ${data.length}`);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–∏—Å—Ç–∞
        let importedCount = 0;

        for (const row of data) {
          // –ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –æ–±—ã—á–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ú–û
          const moName = Object.values(row)[0];
          const moId = MO_MAPPING[moName];

          if (!moId) {
            console.warn(`   ‚ö†Ô∏è –ú–û –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: "${moName}"`);
            continue;
          }

          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
          for (const [colName, colValue] of Object.entries(row)) {
            if (colName === Object.keys(row)[0]) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –ú–û

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (!colValue || colValue === '' || colValue === '-') continue;

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —á–∏—Å–ª–æ
            let numValue = null;
            if (typeof colValue === 'number') {
              numValue = colValue;
            } else if (typeof colValue === 'string') {
              // –£–±–∏—Ä–∞–µ–º %, –∑–∞–ø—è—Ç—ã–µ –∏ –¥—Ä—É–≥–∏–µ —Å–∏–º–≤–æ–ª—ã
              const cleaned = colValue.replace(/[%,\s]/g, '.').replace(/[^\d.-]/g, '');
              numValue = parseFloat(cleaned);
            }

            if (isNaN(numValue) || numValue === null) continue;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (—É–ø—Ä–æ—â—ë–Ω–Ω–æ - –±–µ–∑ —Ç–æ—á–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π)
            // –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã –º–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ ind_code
            importedCount++;
          }
        }

        console.log(`   ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${importedCount} –∑–Ω–∞—á–µ–Ω–∏–π`);
      }

    } finally {
      client.release();
    }

    console.log(`\n‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞`);

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
    console.error(error.stack);
  } finally {
    await pool.end();
  }
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
const excelFile = process.argv[2] ||
  path.join(__dirname, '../Desktop/–î–∞—à–±–æ—Ä–¥ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏/–¢–µ—Å—Ç –¥–∞—à–±–æ—Ä–¥–∞/–û—Ü–µ–Ω–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è v_1.xlsx');

loadExcelData(excelFile).catch(err => {
  console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
  process.exit(1);
});
