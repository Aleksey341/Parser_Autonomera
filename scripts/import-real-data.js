/**
 * ============================================================================
 * ETL —Å–∫—Ä–∏–ø—Ç: –ò–º–ø–æ—Ä—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV –≤ –ë–î
 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ "–û—Ü–µ–Ω–∫–∞_–ø–æ–¥–¥–µ—Ä–∂–∫–∏_—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è_v1__ALL.csv"
 * ============================================================================
 */

const fs = require('fs');
const path = require('path');
const csv = require('csv-parse/sync');
const pool = require('../db/postgres');

// –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π –ú–û –∏–∑ CSV –Ω–∞ ID –≤ –ë–î
const MO_NAME_MAP = {
  '–ì–æ—Ä–æ–¥ –õ–∏–ø–µ—Ü–∫': 1,
  '–õ–∏–ø–µ—Ü–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 2,
  '–ï–ª–µ—Ü–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 3,
  '–ì–æ—Ä–æ–¥ –ï–ª–µ—Ü': 4,
  '–õ–µ–±–µ–¥—è–Ω—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 5,
  '–ì–æ—Ä–æ–¥ –õ–µ–±–µ–¥—è–Ω—å': 6,
  '–°—Ç–∞–Ω–æ–≤–ª—è–Ω—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 7,
  '–î–æ–±—Ä–æ–≤—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 8,
  '–¢–∞–º–±–æ–≤—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 9,
  '–ì—Ä—è–∑–∏–Ω—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω': 10
};

// –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ CSV –Ω–∞ ind_code –≤ –ë–î
const COLUMN_TO_INDICATOR = {
  '–§–∞–∫—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞/–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —É–∫–∞–∑–∞–Ω–∏–π –ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä–∞': 'PUB_001_SUPPORT',
  '–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –ê–ì–ü': 'CLOSED_004_AGP_QUALITY',
  '% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –ê–ì–ü': 'PUB_002_AGP_TASKS',
  '% –ª–∏—á–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è –≥–ª–∞–≤—ã –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö': 'PUB_007_VETERANS',
  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥ –≤ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö/—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω—Ç–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≥–æ–¥–∞': 'PUB_009_GRANTS',
  '–§–∞–∫—Ç –≤–æ–∑–±—É–∂–¥–µ–Ω–∏—è —É–≥–æ–ª–æ–≤–Ω–æ–≥–æ –¥–µ–ª–∞': 'PENALTY_003_LAW_ENFORCEMENT',
  '–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç': 'MO_NAME',
  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ–¥–æ–º—ã—Ö –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤': 'PUB_004_PROJECTS',
  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–∏–∑–æ–¥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π': 'PENALTY_002_CONFLICT_INTERNAL',
  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π –æ—Ç –ú–û –≤ –ø—Ä–æ–µ–∫—Ç–µ': 'CLOSED_007_PRIDE',
  '–§–∞–∫—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏/–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–µ—Ä–≤—ã–º –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª–µ–º –ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä–∞': 'PUB_001_SUPPORT',
  '–û–±—â–µ–µ —á–∏—Å–ª–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏': 'CLOSED_001_PARTY',
  '–§–∞–∫—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∫–ª—é—á–µ–≤—ã—Ö —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π': 'PUB_001_SUPPORT',
  '–û–±—â–∏–π –æ–±—ä–µ–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤': 'PUB_009_GRANTS',
  '–§–∞–∫—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–∏–ª–æ–≤—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä/–∞—Ä–µ—Å—Ç–æ–≤': 'PENALTY_003_LAW_ENFORCEMENT',
  '% –æ–±—Ä–∞—â–µ–Ω–∏–π, –ø–æ–ª—É—á–∏–≤—à–∏—Ö —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ –≤–∑—è—Ç—ã—Ö –≤ —Ä–∞–±–æ—Ç—É': 'PUB_007_VETERANS',
  '% —á–ª–µ–Ω–æ–≤ –ø–∞—Ä—Ç–∏–∏ –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –≤–µ—Ç–µ—Ä–∞–Ω–æ–≤': 'CLOSED_006_VETERANS_ACT',
  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—á–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –°–í–û': 'PUB_007_VETERANS',
  '–ù–∞–ª–∏—á–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ –°–ú–ò': 'PUB_003_POSITION',
  '% –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –≥–ª–∞–≤–Ω–æ–≥–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è': null,
  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–ª–æ–¥–µ–∂–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤': 'PUB_005_VOLUNTEERS',
  '% –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è': null,
  '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π –º–æ–ª–æ–¥–µ–∂–∏ –≤ –≥–æ—Ä–æ–¥—Å–∫–æ–º —Å–æ–≤–µ—Ç–µ': 'PUB_005_VOLUNTEERS',
  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º': null,
  '% –∫–æ–Ω–∫—É—Ä—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–º–µ—â–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π': 'PUB_008_RESERVE',
  '–†–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–∞–¥—Ä–æ–≤–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏': null,
  '% —Ç–µ–∫—É—á–µ—Å—Ç–∏ –∫–∞–¥—Ä–æ–≤': 'PUB_008_RESERVE',
  '–§–∞–∫—Ç –Ω–∞–ª–∏—á–∏—è –º–æ–ª–æ–¥–µ–∂–Ω–æ–≥–æ –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞': 'PUB_005_VOLUNTEERS',
  '% —É—á–∞—Å—Ç–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ "–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö"': 'PUB_006_DP_ACTIVE',
  '–§–∞–∫—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ (–Ω–∞–ª–∏—á–∏–µ "—Ç–æ—á–µ–∫ —Ä–æ—Å—Ç–∞")': null,
  '% –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–ª–æ–¥–µ–∂–∏ –≤ –ø—Ä–æ–µ–∫—Ç—ã': 'PUB_005_VOLUNTEERS',
  '–§–∞–∫—Ç –Ω–∞–ª–∏—á–∏—è –ø—Ä–æ—Ä—ã–≤–∞ –ø–æ –º–æ–ª–æ–¥–µ–∂–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ –≤ –ø–µ—Ä–∏–æ–¥ 2023-2024': null
};

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞
 */
async function importRealData() {
  const client = await pool.connect();

  try {
    console.log('\n' + '='.repeat(70));
    console.log('üì• –ò–ú–ü–û–†–¢ –†–ï–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–• –ò–ó CSV');
    console.log('='.repeat(70));

    // –ß–∏—Ç–∞–µ–º CSV —Ñ–∞–π–ª
    const csvPath = path.join(__dirname, '../',
      'Desktop/–î–∞—à–±–æ—Ä–¥ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏/–¢–µ—Å—Ç –¥–∞—à–±–æ—Ä–¥–∞/–û—Ü–µ–Ω–∫–∞_–ø–æ–¥–¥–µ—Ä–∂–∫–∏_—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è_v1__ALL.csv');

    if (!fs.existsSync(csvPath)) {
      console.error(`‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${csvPath}`);
      return;
    }

    const fileContent = fs.readFileSync(csvPath, 'utf-8');
    const records = csv.parse(fileContent, {
      columns: true,
      skip_empty_lines: true,
      encoding: 'utf-8'
    });

    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${records.length} —Å—Ç—Ä–æ–∫ –∏–∑ CSV`);

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É
    let importedCount = 0;
    let skippedCount = 0;

    for (const record of records) {
      const moName = record['–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç'];
      const moId = MO_NAME_MAP[moName];

      if (!moId) {
        console.warn(`‚ö†Ô∏è –ú–û –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –º–∞–ø–ø–∏–Ω–≥–µ: ${moName}`);
        skippedCount++;
        continue;
      }

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∫–æ–ª–æ–Ω–∫—É –≤ –∑–∞–ø–∏—Å–∏
      for (const [columnName, value] of Object.entries(record)) {
        const indCode = COLUMN_TO_INDICATOR[columnName];

        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        if (!indCode || !value || value.trim() === '') continue;

        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è
        const indResult = await client.query(
          'SELECT ind_id FROM dim_indicators WHERE ind_code = $1',
          [indCode]
        );

        if (indResult.rows.length === 0) {
          console.warn(`‚ö†Ô∏è –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: ${indCode}`);
          continue;
        }

        const indId = indResult.rows[0].ind_id;

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (—É–¥–∞–ª—è–µ–º %, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —á–∏—Å–ª–∞)
        let numValue = parseFloat(value.toString().replace('%', '').replace(',', '.'));
        if (isNaN(numValue)) numValue = null;

        // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –ë–î
        try {
          await client.query(
            `INSERT INTO fact_indicator_values
             (mo_id, period_id, ind_id, version_id, value_raw, source_id, comment, created_at)
             VALUES ($1, $2, $3, $4, $5, $6, $7, NOW())
             ON CONFLICT (mo_id, period_id, ind_id, version_id) DO UPDATE SET
             value_raw = $5, updated_at = NOW()`,
            [moId, 202406, indId, 'v1', numValue, 1, `–ò–º–ø–æ—Ä—Ç –∏–∑ CSV: ${columnName}`]
          );
          importedCount++;
        } catch (err) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ: ${err.message}`);
        }
      }
    }

    console.log(`\n‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω:`);
    console.log(`   - –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${importedCount}`);
    console.log(`   - –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${skippedCount}`);

    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∏
    console.log(`\nüîÑ –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é —Ä–µ–π—Ç–∏–Ω–≥–∏...`);
    const recalcResult = await client.query(
      `UPDATE fact_summary_ratings SET score_total = NULL WHERE period_id = 202406 AND version_id = 'v1'`
    );
    console.log(`‚úÖ –†–µ–π—Ç–∏–Ω–≥–∏ –æ—Ç–º–µ—á–µ–Ω—ã –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞`);

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error.message);
    console.error(error.stack);
  } finally {
    client.release();
    await pool.end();
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏–º–ø–æ—Ä—Ç
importRealData().catch(err => {
  console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
  process.exit(1);
});
