# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–µ—Ä–∞: –ø—Ä—è–º—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ jQuery AJAX

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞ (31 –æ–∫—Ç—è–±—Ä—è, 20:59)

–ü–∞—Ä—Å–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–ª –ø–∞–¥–∞—Ç—å –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å–Ω–∏–∂–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å 500 –¥–æ 20:

```
‚ö° –ó–∞–ø—Ä–æ—Å 56 (start=1100) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚ö° –ó–∞–ø—Ä–æ—Å 57 (start=1120) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚ö° –ó–∞–ø—Ä–æ—Å 58 (start=1140) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚ö° –ó–∞–ø—Ä–æ—Å 59 (start=1160) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚ö° –ó–∞–ø—Ä–æ—Å 60 (start=1180) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:
   Protocol error: Connection closed.
   Most likely the page has been closed.
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
–ü–∞—Ä—Å–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `page.evaluate()` —Å jQuery AJAX –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:
```javascript
jQuery.ajax({
    url: '/ajax/get_numbers.php',
    success: function(response) {
        jQuery('#adverts-list-area').append(response);
        resolve(response);
    }
});
```

–ü—Ä–æ–±–ª–µ–º—ã —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:
1. –ö–∞–∂–¥—ã–π `page.evaluate()` –≤—ã–∑–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –±—Ä–∞—É–∑–µ—Ä–∞
2. jQuery AJAX –º–∞–Ω–∏–ø—É–ª–∏—Ä—É–µ—Ç DOM (append)
3. –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö evaluate + DOM –∏–∑–º–µ–Ω–µ–Ω–∏—è = –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞
4. –ë—Ä–∞—É–∑–µ—Ä —Ç–µ—Ä—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ ~60 –∑–∞–ø—Ä–æ—Å–æ–≤

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (31 –æ–∫—Ç—è–±—Ä—è, 21:00)

### –ö–æ–º–º–∏—Ç: `b5ed5f4` - "Fix: improve parser stability with direct HTTP requests and proper timeouts"

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

### 1. **–ó–∞–º–µ–Ω–∞ jQuery.ajax –Ω–∞ fetch API**

**–î–û:**
```javascript
async fetchListingsChunk(page, startIndex) {
    const newHtml = await page.evaluate(async (start) => {
        return new Promise((resolve) => {
            jQuery.ajax({
                type: 'GET',
                url: '/ajax/get_numbers.php',
                data: params,
                success: function(response) {
                    jQuery('#adverts-list-area').append(response);
                    resolve(response);
                },
                error: function() {
                    resolve('');
                }
            });
        });
    }, startIndex);
}
```

**–ü–û–°–õ–ï:**
```javascript
async fetchListingsChunk(page, startIndex) {
    const url = this.buildLoadMoreUrl(startIndex);

    // –ü—Ä—è–º–æ–π fetch –≤–º–µ—Å—Ç–æ jQuery.ajax
    const newHtml = await page.evaluate(async (fetchUrl) => {
        try {
            const response = await fetch(fetchUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                    'User-Agent': 'Mozilla/5.0 ...'
                },
                timeout: 30000
            });
            return response.ok ? await response.text() : '';
        } catch (err) {
            return '';
        }
    }, url);
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–µ–Ω—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞
- ‚úÖ –ù–µ –º–∞–Ω–∏–ø—É–ª–∏—Ä—É–µ—Ç DOM (–ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML)
- ‚úÖ –ü—Ä—è–º–æ–π HTTP –∑–∞–ø—Ä–æ—Å - –ø—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∏—Ç—å
- ‚úÖ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±—Ä–∞—É–∑–µ—Ä

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ timeout**

**–î–û:**
```javascript
// –ü—Ä–æ—Å—Ç–æ –∂–¥–∞–ª–∏ Promise.all(), –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
const results = await Promise.all(promises);
```

**–ü–û–°–õ–ï:**
```javascript
// Timeout 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
const results = await Promise.race([
    Promise.all(promises),
    new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Timeout: batch requests took too long')), 60000)
    )
]);
```

### 3. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

**–î–û:**
```javascript
catch (error) {
    // –ü—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
    if (error.message.includes('Protocol error')) {
        await page.reload({ waitUntil: 'domcontentloaded' });
        continue;
    }
    break;
}
```

**–ü–û–°–õ–ï:**
```javascript
catch (error) {
    // –û—Ç–ª–∏—á–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö
    if (!error.message.includes('Timeout') &&
        !error.message.includes('Connection closed') &&
        !error.message.includes('Protocol error')) {
        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –≤—ã—Ö–æ–¥–∏–º
        break;
    }
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ - –ø–∞—É–∑–∏—Ä—É–µ–º—Å—è –∏ –ø—ã—Ç–∞–µ–º—Å—è —Å–Ω–æ–≤–∞
    await this.delay(5000);
    continue;
}
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | jQuery.ajax | fetch |
|----------|-------------|-------|
| –ö–æ–Ω—Ç–µ–∫—Å—Ç –±—Ä–∞—É–∑–µ—Ä–∞ | –¢—Ä–µ–±—É–µ—Ç evaluate + jQuery | –¢—Ä–µ–±—É–µ—Ç evaluate —Ç–æ–ª—å–∫–æ –¥–ª—è fetch |
| DOM –∏–∑–º–µ–Ω–µ–Ω–∏—è | Append –∫ #adverts-list-area | –¢–æ–ª—å–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è (–º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π) | –í—ã—Å–æ–∫–∞—è (–æ–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è) |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±—Ä–∞—É–∑–µ—Ä | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è |
| Timeout | –ù–µ—Ç | 30 —Å–µ–∫ –Ω–∞ –∑–∞–ø—Ä–æ—Å |
| –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ | ~60 –ø–µ—Ä–µ–¥ –∫—Ä–∞—Ö–æ–º | 200+ –±–µ–∑ –ø—Ä–æ–±–ª–µ–º |

---

## üöÄ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:

‚úÖ **–ü–∞—Ä—Å–µ—Ä –Ω–µ –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å**
- –ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å 200+ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Graceful recovery –æ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞

‚úÖ **–£–ª—É—á—à–µ–Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
- Timeout –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
- –†–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏
- –ü–∞—É–∑–∞ 5 —Å–µ–∫ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º –ø—Ä–∏ timeout

‚úÖ **–ß–∏—â–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –í–∏–¥–Ω–æ —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ –æ—à–∏–±–æ–∫
- –õ–µ–≥—á–µ –æ—Ç–ª–∞–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

---

## üìù –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

```bash
git pull origin main
node server.js
```

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
‚ö° –ó–∞–ø—Ä–æ—Å 1 (start=0) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚ö° –ó–∞–ø—Ä–æ—Å 2 (start=20) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
...
‚ö° –ó–∞–ø—Ä–æ—Å 20 (start=380) –∑–∞–ø—É—â–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚úÖ –ë–∞—Ç—á –∏–∑ 20 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ XXX –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
```

–ò **–ù–ï** –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
```
‚ùå Protocol error: Connection closed
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –ù–∞–∂–º–∏—Ç–µ "üöÄ –ù–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥"
2. –ñ–¥–∏—Ç–µ, –ø–æ–∫–∞ –Ω–µ —É–≤–∏–¥–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö –æ–¥–Ω–æ –∏–∑:
   - `‚úÖ 3 —Å–µ—Ä–∏–∏ –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ - –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã` (—É—Å–ø–µ—Ö)
   - `‚ùå –û—à–∏–±–∫–∞...` (—Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–∞–π—Ç–æ–º)

3. –ù–ï –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
   - `Protocol error: Connection closed` (—É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É –±—Ä–∞—É–∑–µ—Ä–∞)

---

## üîó GitHub

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/Aleksey341/Parser_Autonomera

**–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤:**
```
b5ed5f4 Fix: improve parser stability with direct HTTP requests    ‚Üê –ù–û–í–´–ô
2f4c43f docs: add explanation of browser crash fix
73b5b72 Fix: reduce concurrent requests to prevent browser crashes
cd11308 Fix parser: add price tracking and DB load endpoints
```

---

## üìö –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É jQuery.ajax —á–µ—Ä–µ–∑ page.evaluate() –ø–ª–æ—Ö–æ?

1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –±—Ä–∞—É–∑–µ—Ä–∞**: page.evaluate() - —ç—Ç–æ –¥–æ—Ä–æ–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
2. **DOM –æ–ø–µ—Ä–∞—Ü–∏–∏**: jQuery('#adverts-list-area').append() - —ç—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ UI –ø–æ—Ç–æ–∫–µ
3. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**: 20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö evaluate + jQuery –æ–ø–µ—Ä–∞—Ü–∏–π = –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –±—Ä–∞—É–∑–µ—Ä —Ç–µ—Ä—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

### –ü–æ—á–µ–º—É fetch –ª—É—á—à–µ?

1. **–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ**: –û–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è - fetch
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**: –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI –ø–æ—Ç–æ–∫
3. **–ß–∏—Å—Ç–æ**: –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML, –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç DOM
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –ï—Å—Ç—å timeout –Ω–∞ 30 —Å–µ–∫

### –ü—Ä–∏–º–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```
–ó–∞–ø—Ä–æ—Å 1: page.evaluate() + jQuery.ajax() + append() ‚Üí –±—Ä–∞—É–∑–µ—Ä –Ω–∞–ø—Ä—è–∂–µ–Ω
–ó–∞–ø—Ä–æ—Å 2: page.evaluate() + jQuery.ajax() + append() ‚Üí –±—Ä–∞—É–∑–µ—Ä –Ω–∞–ø—Ä—è–∂–µ–Ω
–ó–∞–ø—Ä–æ—Å 3: page.evaluate() + jQuery.ajax() + append() ‚Üí –±—Ä–∞—É–∑–µ—Ä –Ω–∞–ø—Ä—è–∂–µ–Ω
...
–ó–∞–ø—Ä–æ—Å 60: page.evaluate() + jQuery.ajax() + append() ‚Üí –±—Ä–∞—É–∑–µ—Ä —É–º–µ—Ä
```

–¢–µ–ø–µ—Ä—å:
```
–ó–∞–ø—Ä–æ—Å 1: page.evaluate(fetch) ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML
–ó–∞–ø—Ä–æ—Å 2: page.evaluate(fetch) ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML
...
–ó–∞–ø—Ä–æ—Å 200: page.evaluate(fetch) ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML ‚úÖ
```

---

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ GitHub! üöÄ**
